package CRUD;

import org.junit.Test;
import org.openqa.selenium.*;
import org.openqa.selenium.chrome.ChromeDriver;
import org.openqa.selenium.support.ui.ExpectedConditions;
import org.openqa.selenium.support.ui.WebDriverWait;
import org.apache.commons.io.FileUtils;
import java.io.File;
import java.io.IOException;
import java.time.Duration;

import static org.junit.Assert.*;

public class TestEditProduct {

    final String TARGET_PRODUCTS_ID = "43";
    final String PRODUCT_NAME = "Test Product " + System.currentTimeMillis();
    final String EDITED_NAME = PRODUCT_NAME + " Edited";
    final String PRODUCT_PRICE = "10000";
    final String EDITED_PRICE = "20000";
    final String PRODUCT_DESCRIPTION = "Initial product description";
    final String EDITED_DESCRIPTION = "Updated product description";
    final String IMAGE_PATH = "D:\\java5\\AsmGD1\\AsmGD1\\asm\\src\\main\\resources\\static\\img\\NikeAirForce1.jpg";

    @Test
    public void testEditProduct() {
        System.setProperty("webdriver.chrome.driver", "C:\\Users\\ASUS\\Downloads\\chromedriver-win64\\chromedriver.exe");
        WebDriver driver = new ChromeDriver();
        WebDriverWait wait = new WebDriverWait(driver, Duration.ofSeconds(25));

        try {
            // [1] ƒêƒÇNG NH·∫¨P
            driver.get("http://localhost:8080/login");

            // ƒêi·ªÅn th√¥ng tin ƒëƒÉng nh·∫≠p
            wait.until(ExpectedConditions.visibilityOfElementLocated(By.name("email"))).sendKeys("admin.nguyen@example.com");
            wait.until(ExpectedConditions.visibilityOfElementLocated(By.name("password"))).sendKeys("adminpass");
            wait.until(ExpectedConditions.elementToBeClickable(By.cssSelector("button[type='submit']"))).click();

            // [2] TH√äM S·∫¢N PH·∫®M M·ªöI
            driver.get("http://localhost:8080/admin/edit-product");

            // Verify trang th√™m s·∫£n ph·∫©m
            wait.until(ExpectedConditions.textToBePresentInElementLocated(
                By.xpath("//h2[contains(@class, 'text-center')]"),
                "S·ª≠a s·∫£n ph·∫©m"
            ));

            wait.until(ExpectedConditions.urlContains("/edit/" + TARGET_PRODUCTS_ID));
            
            // ƒêi·ªÅn th√¥ng tin s·∫£n ph·∫©m
            fillProductForm(driver, PRODUCT_NAME, PRODUCT_PRICE, PRODUCT_DESCRIPTION);

            // Upload ·∫£nh v√† submit
            WebElement fileInput = driver.findElement(By.cssSelector("input[name='photoFile']"));
            fileInput.sendKeys(IMAGE_PATH);
            
            // X·ª≠ l√Ω overlay n·∫øu c√≥
            removeOverlayIfExists(driver);
            
            // Nh·∫•n n√∫t "L∆∞u thay ƒë·ªïi"
            WebElement saveButton = wait.until(ExpectedConditions.elementToBeClickable(By.xpath("//button[contains(., 'L∆∞u thay ƒë·ªïi')]")));
            scrollToElement(driver, saveButton);
            saveButton.click();

            // Ch·ªù chuy·ªÉn trang
            wait.until(ExpectedConditions.urlContains("/adminproducts"));

            // [3] T√åM V√Ä CH·ªàNH S·ª¨A S·∫¢N PH·∫®M
            WebElement productCard = wait.until(ExpectedConditions.presenceOfElementLocated(
                By.xpath("//div[contains(@class, 'card')][.//*[contains(text(), '" + PRODUCT_NAME + "')]]")
            ));

            // L·∫•y link ch·ªânh s·ª≠a
            String editUrl = productCard.findElement(By.cssSelector("a[href*='/admin/edit-product/']")).getAttribute("href");
            driver.get(editUrl);

            // Verify trang ch·ªânh s·ª≠a
            wait.until(ExpectedConditions.textToBePresentInElementLocated(
                By.xpath("//h2[contains(@class, 'text-center')]"),
                "Ch·ªânh s·ª≠a s·∫£n ph·∫©m"
            ));

            // C·∫≠p nh·∫≠t th√¥ng tin
            fillProductForm(driver, EDITED_NAME, EDITED_PRICE, EDITED_DESCRIPTION);
            
            // X·ª≠ l√Ω overlay tr∆∞·ªõc khi nh·∫•n
            removeOverlayIfExists(driver);
            
            // Nh·∫•n n√∫t "L∆∞u thay ƒë·ªïi"
            WebElement saveEditButton = wait.until(ExpectedConditions.elementToBeClickable(By.xpath("//button[contains(., 'L∆∞u thay ƒë·ªïi')]")));
            scrollToElement(driver, saveEditButton);
            saveEditButton.click();

            // [4] KI·ªÇM TRA K·∫æT QU·∫¢
            wait.until(ExpectedConditions.urlContains("/adminproducts"));
            WebElement editedProduct = wait.until(ExpectedConditions.visibilityOfElementLocated(
                By.xpath("//div[contains(@class, 'card')][.//*[contains(text(), '" + EDITED_NAME + "')]]")
            ));

            assertTrue("S·∫£n ph·∫©m ch∆∞a ƒë∆∞·ª£c c·∫≠p nh·∫≠t", editedProduct.isDisplayed());

        } catch (Exception e) {
            takeScreenshot(driver, "edit_product_error");
            fail("Test th·∫•t b·∫°i: " + e.getMessage());
        } finally {
            driver.quit();
        }
    }

    private void fillProductForm(WebDriver driver, String name, String price, String description) {
        JavascriptExecutor js = (JavascriptExecutor) driver;

        // ƒêi·ªÅn t√™n s·∫£n ph·∫©m
        WebElement nameField = driver.findElement(By.cssSelector("input[placeholder='Nh·∫≠p t√™n s·∫£n ph·∫©m']"));
        scrollToElement(driver, nameField);
        nameField.clear();
        nameField.sendKeys(name);

        // ƒêi·ªÅn gi√°
        WebElement priceField = driver.findElement(By.cssSelector("input[placeholder='Nh·∫≠p gi√° s·∫£n ph·∫©m']"));
        priceField.clear();
        priceField.sendKeys(price);

        // ƒêi·ªÅn m√¥ t·∫£
        WebElement descField = driver.findElement(By.cssSelector("textarea[placeholder='Nh·∫≠p m√¥ t·∫£ s·∫£n ph·∫©m']"));
        descField.clear();
        descField.sendKeys(description);

        try { Thread.sleep(500); }
        catch (InterruptedException e) { Thread.currentThread().interrupt(); }
    }

    private void scrollToElement(WebDriver driver, WebElement element) {
        ((JavascriptExecutor) driver).executeScript(
            "arguments[0].scrollIntoView({behavior: 'smooth', block: 'center'});", 
            element
        );
        try { Thread.sleep(500); }
        catch (InterruptedException e) { Thread.currentThread().interrupt(); }
    }

    private void removeOverlayIfExists(WebDriver driver) {
        try {
            WebElement overlay = driver.findElement(By.cssSelector(".overlay-class")); // Thay b·∫±ng class overlay th·ª±c t·∫ø
            if (overlay.isDisplayed()) {
                ((JavascriptExecutor) driver).executeScript("arguments[0].style.display='none';", overlay);
                System.out.println("üîÑ ƒê√£ t·∫Øt overlay ch·∫∑n n√∫t b·∫•m");
            }
        } catch (NoSuchElementException e) {
            // Kh√¥ng c√≥ overlay, ti·∫øp t·ª•c b√¨nh th∆∞·ªùng
        }
    }

    private void takeScreenshot(WebDriver driver, String fileName) {
        try {
            File srcFile = ((TakesScreenshot) driver).getScreenshotAs(OutputType.FILE);
            FileUtils.copyFile(srcFile, new File(fileName + ".png"));
        } catch (IOException e) {
            System.err.println("Kh√¥ng ch·ª•p ƒë∆∞·ª£c m√†n h√¨nh: " + e.getMessage());
        }
    }
}
