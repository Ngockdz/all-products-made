package CRUD;

import org.junit.Test;
import org.openqa.selenium.*;
import org.openqa.selenium.chrome.ChromeDriver;
import org.openqa.selenium.support.ui.ExpectedConditions;
import org.openqa.selenium.support.ui.WebDriverWait;
import java.time.Duration;
import static org.junit.Assert.*;

public class TestaddProductById {

    // Th√¥ng tin s·∫£n ph·∫©m m·∫´u
    final String PRODUCT_NAME = "New Product Test " + System.currentTimeMillis(); // Th√™m timestamp ƒë·ªÉ tr√°nh tr√πng l·∫∑p
    final String PRODUCT_PRICE = "10000";
    final String PRODUCT_DESCRIPTION = "This is a test product description";
    final String IMAGE_PATH = "D:\\java5\\AsmGD1\\AsmGD1\\asm\\src\\main\\resources\\static\\img\\NikeAirForce1.jpg"; // S·ª≠ d·ª•ng bi·∫øn ƒë√£ khai b√°o

    @Test
    public void testAddProduct() {
        System.setProperty("webdriver.chrome.driver", "C:\\Users\\ASUS\\Downloads\\chromedriver-win64\\chromedriver.exe");
        WebDriver driver = new ChromeDriver();
        WebDriverWait wait = new WebDriverWait(driver, Duration.ofSeconds(15));

        try {
            // [1] ƒêƒÇNG NH·∫¨P
            driver.get("http://localhost:8080/login");
            System.out.println("‚úÖ ƒê√£ m·ªü trang ƒëƒÉng nh·∫≠p");

            // [1.1] Nh·∫≠p th√¥ng tin ƒëƒÉng nh·∫≠p (S·ª≠ d·ª•ng CSS selector ch√≠nh x√°c h∆°n)
            WebElement emailField = wait.until(ExpectedConditions.visibilityOfElementLocated(
                By.cssSelector("input[name='email']") // Gi·∫£ ƒë·ªãnh HTML d√πng name="email"
            ));
            emailField.sendKeys("admin.nguyen@example.com");
            System.out.println("‚úÖ ƒê√£ nh·∫≠p email");

            WebElement passField = driver.findElement(By.cssSelector("input[name='password']"));
            passField.sendKeys("adminpass");
            System.out.println("‚úÖ ƒê√£ nh·∫≠p m·∫≠t kh·∫©u");

            // [1.2] Submit form ƒëƒÉng nh·∫≠p
            WebElement loginButton = driver.findElement(By.cssSelector("button[type='submit']"));
            loginButton.click();
            System.out.println("‚úÖ ƒê√£ click n√∫t ƒëƒÉng nh·∫≠p");

            // [1.3] Ch·ªù chuy·ªÉn h∆∞·ªõng ƒë·∫øn trang admin (Thay b·∫±ng URL ƒë√≠ch ch√≠nh x√°c)
            wait.until(ExpectedConditions.urlToBe("http://localhost:8080/adminproducts"));
            System.out.println("‚úÖ ƒêƒÉng nh·∫≠p th√†nh c√¥ng, chuy·ªÉn h∆∞·ªõng ƒë·∫øn trang qu·∫£n l√Ω");

            // [2] TRUY C·∫¨P TRANG TH√äM S·∫¢N PH·∫®M
            System.out.println("‚úÖ ƒê√£ v√†o trang th√™m s·∫£n ph·∫©m");

            // [3] ƒêI·ªÄN FORM TH√äM S·∫¢N PH·∫®M
            WebElement nameField = wait.until(ExpectedConditions.presenceOfElementLocated(
                By.cssSelector("input[name='nameproduct']")
            ));
            scrollToElement(driver, nameField);
            nameField.sendKeys(PRODUCT_NAME);
            System.out.println("‚úÖ ƒê√£ ƒëi·ªÅn t√™n s·∫£n ph·∫©m");

            WebElement priceField = driver.findElement(By.cssSelector("input[name='price']"));
            scrollToElement(driver, priceField);
            priceField.sendKeys(PRODUCT_PRICE);
            System.out.println("‚úÖ ƒê√£ ƒëi·ªÅn gi√° s·∫£n ph·∫©m");

            WebElement descriptionField = driver.findElement(By.cssSelector("textarea[name='description']"));
            scrollToElement(driver, descriptionField);
            descriptionField.sendKeys(PRODUCT_DESCRIPTION);
            System.out.println("‚úÖ ƒê√£ ƒëi·ªÅn m√¥ t·∫£");

            WebElement fileInput = driver.findElement(By.cssSelector("input[name='photoFile']"));
            fileInput.sendKeys(IMAGE_PATH); // S·ª≠a th√†nh IMAGE_PATH
            System.out.println("‚úÖ ƒê√£ t·∫£i l√™n ·∫£nh");

            // [4] SUBMIT FORM
            WebElement submitButton = wait.until(ExpectedConditions.elementToBeClickable(
                By.cssSelector("button.btn-primary") // Locator theo class c·ªßa n√∫t
            ));
            scrollToElement(driver, submitButton);
            submitButton.click();
            System.out.println("‚úÖ ƒê√£ g·ª≠i form th√™m s·∫£n ph·∫©m");

            // [5] KI·ªÇM TRA K·∫æT QU·∫¢
            // [5.1] Ch·ªù chuy·ªÉn h∆∞·ªõng v√† ki·ªÉm tra URL
            wait.until(ExpectedConditions.urlToBe("http://localhost:8080/adminproducts"));
            System.out.println("‚úÖ ƒê√£ chuy·ªÉn h∆∞·ªõng v·ªÅ trang qu·∫£n l√Ω");

            // [5.2] Ki·ªÉm tra th√¥ng b√°o th√†nh c√¥ng
            WebElement successAlert = wait.until(ExpectedConditions.visibilityOfElementLocated(
                By.cssSelector("div.alert-success")
            ));
            assertTrue("Thi·∫øu th√¥ng b√°o th√†nh c√¥ng", 
                successAlert.getText().toLowerCase().contains("th√†nh c√¥ng")
            );
            System.out.println("‚úÖ Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng");

            // [5.3] Ki·ªÉm tra s·∫£n ph·∫©m trong danh s√°ch
            WebElement newProduct = wait.until(ExpectedConditions.visibilityOfElementLocated(
                By.xpath("//h5[contains(text(), '" + PRODUCT_NAME + "')]")
            ));
            assertTrue("Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m m·ªõi", newProduct.isDisplayed());
            System.out.println("‚úÖ S·∫£n ph·∫©m xu·∫•t hi·ªán trong danh s√°ch");

        } catch (Exception e) {
            System.err.println("‚ùå L·ªói trong qu√° tr√¨nh test: " + e.getMessage());
            e.printStackTrace();
            fail("Test th·∫•t b·∫°i do exception");
        } finally {
            driver.quit();
            System.out.println("üõë ƒê√£ ƒë√≥ng tr√¨nh duy·ªát");
        }
    }

    // [H√†m ph·ª• tr·ª£] Cu·ªôn ƒë·∫øn ph·∫ßn t·ª≠
    private void scrollToElement(WebDriver driver, WebElement element) {
        ((JavascriptExecutor) driver).executeScript(
            "arguments[0].scrollIntoView({behavior: 'smooth', block: 'center'});", 
            element
        );
        try {
            Thread.sleep(500); // Ch·ªù cu·ªôn ho√†n t·∫•t
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
    }
}